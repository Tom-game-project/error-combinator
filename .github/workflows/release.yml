name: Publish

on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Version consistency check
      - name: Check version consistency
        shell: bash
        run: |
          # 1. Extract the version number from the Git tag (refs/tags/v1.0.0 -> 1.0.0)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}

          # 2. Get the version from Cargo.toml (using cargo metadata command)
          CARGO_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')

          echo "Git Tag: v$TAG_VERSION"
          echo "Cargo Version: $CARGO_VERSION"

          if; then
            echo "::error::Version mismatch! Git tag is v$TAG_VERSION but Cargo.toml says $CARGO_VERSION"
            exit 1
          fi

      #- name: Auth with crates.io
      #  uses: rust-lang/crates-io-auth-action@v1
      #
      #- name: Publish
      #  run: cargo publish
